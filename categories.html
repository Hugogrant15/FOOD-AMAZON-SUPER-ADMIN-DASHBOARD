<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>360 Organic Foodie - Super-Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="style.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    
  </style>
</head>
<body>
    <!-- Desktop Navbar (visible on md and up) -->
      <nav class="navbar navbar-expand-md bg-white d-none d-md-flex fixed-top">
        <div class="container-fluid">
          <img src="./images/Foodies logo without Banner 1.png" style="width: 50px; height: 50px" alt="">
          <span class="Navlogo1 d-md-none">360 Organic Foodie</span>

          <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto">
              <li class="nav-item">
                <div class="input-group Navborder">
                  <button class="btn btn-outline-secondary border-0" type="button">
                    <i class="fas fa-search"></i>
                  </button>
                  <input type="text" class="form-control border-0" placeholder="Search here...">
                </div>
              </li>
            </ul>

            <form class="d-flex">
              <div class="d-flex align-items-center">
                <button class="text-reset me-3 btnSharp"><i class="fa-solid fa-cart-shopping"></i></button>
                <button class="text-reset me-4 btnSharp position-relative" onclick="toggleNotification(event)">
                  <i class="fas fa-bell"></i>
                  <span id="notificationBadge"
                        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                        style="font-size: 0.7rem; display:none;">
                  </span>
                </button>


                <img id="userAvatar" class="me-3 rounded-circle" src="./images/cheerful-curly-man-with-bristle-points-left-wears-casual-clothes-spectacles 1.png" alt="User Avatar" width="40" height="40">
                <span id="userName" class="CustomP-14-400 me-3 text-dark fw-semibold"></span>
              </div>
            </form>
            <!-- notification pop-up  -->
              <div class="col-md-4" id="notificationPopUp">
                  <div class="card p-3" style=" overflow-y: auto;">
                    <h6 class="fw-bold mb-3">Recent Activities in Your City</h6>
                    <ul class="list-unstyled" id="activityFeed"></ul>
                  </div>
              </div>
          </div>
        </div>
      </nav>

      <!-- Mobile Navbar (visible only on sm) -->
      <nav class="navbar bg-white px-3 d-flex justify-content-between align-items-center d-flex d-sm-flex d-md-none">
        <!-- Left side -->
        <div class="d-flex align-items-center">
          <!-- Hamburger -->
          <button class="btn p-0 me-3" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
            <i class="fa-solid fa-bars fs-4"></i>
          </button>

          <!-- Search -->
           <div class="search-container">
            <button class="btn p-0" id="mobileSearchBtn" aria-label="Open search">
              <i class="fa-solid fa-magnifying-glass fs-5 text-muted"></i>
            </button>

            <input
              type="text"
              id="mobileSearchInput"
              class="mobile-search-input"
              placeholder="Search dashboard..."
              aria-label="Search dashboard"
            />
          </div>

          <!-- <div class="search-container position-relative">
            <button class="btn p-0" id="mobileSearchBtn">
              <i class="fa-solid fa-magnifying-glass fs-5 text-muted"></i>
            </button>
            <input type="text" id="mobileSearchInput" class="form-control form-control-sm position-absolute"
              placeholder="Search..."
              style="width: 0; opacity: 0; transition: all 0.3s ease; left: 40px; top: 0; z-index: 1000;">
          </div> -->
        </div>

        <!-- Right side -->
        <div class="d-flex align-items-center">
          <!-- Bell -->
          <button class="text-reset me-1 btnSharp position-relative" onclick="toggleNotification(event)">
                  <i class="fas fa-bell"></i>
                  <span id="notificationBadge1"
                        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                        style="font-size: 0.7rem; display:none;">
                  </span>
                </button>

          <!-- Profile -->
          <img src="./images/cheerful-curly-man-with-bristle-points-left-wears-casual-clothes-spectacles 1.png"
              class="rounded-circle"
              alt="Profile" width="40" height="40">
        </div>
              <div class="col-md-4" id="notificationPopUp1">
                  <div class="card p-3" style=" overflow-y: auto;">
                    <h6 class="fw-bold mb-3">Recent Activities in Your City</h6>
                    <ul class="list-unstyled" id="activityFeed1"></ul>
                  </div>
              </div>
      </nav>

      <!-- Sidebar (offcanvas for mobile) -->
      <div class="offcanvas offcanvas-start sidebar" tabindex="-1" id="sidebarMenu">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title">Menu</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-4">
          <ul class="listItem">
            <li><a href="./dashboard.html" class="active" style="text-decoration: none; color: #8D98AF; "><i class="fa-solid fa-house me-3"></i>Dashboard</a></li>
            <li><a href="./orders.html" style="text-decoration: none; color: #8D98AF; "><i class="fa-solid fa-cart-shopping me-3"></i>Orders</a></li>
            <li><a href="./product.html" class="" style="text-decoration: none; color: #8D98AF;"><i class="fa-solid fa-cart-shopping me-3"></i></span><span>Product</span></a></li>
            <li><a href="./categories.html" class="" style="text-decoration: none; color: #8D98AF;"><i class="fa-solid fa-layer-group me-3"></i></span><span>Category</span></a></li>
            <li><a href="./customers.html" style="text-decoration: none; color: #8D98AF; "><i class="fa-solid fa-user me-3"></i>Customers</a></li>
            <li><a href="./distributor.html" style="text-decoration: none; color: #8D98AF; "><i class="fa-solid fa-user me-3"></i>distributors</a></li>
            <li><a href="./" style="text-decoration: none; color: #8D98AF;"><i class="fa-solid fa-file-invoice me-3"></i></span><span>Reports</span></a></li>
            <li><a href="./notifications.html" style="text-decoration: none; color: #8D98AF;"><i class="fa-solid fa-bell me-3"></i></span><span>Notifications</span></a></li>
            <li><a href="" style="text-decoration: none; color: #8D98AF;"><i class="fa-solid fa-receipt fa-beat me-3"></i></span><span>Coupon</span></a></li>
            <hr>
            <li><a href="" style="text-decoration: none; color: #8D98AF;"><i class="fa-solid fa-envelope me-3"></i></span><span>Inbox</span></a></li>
            <li><a href="#" style="text-decoration: none; color: #8D98AF; "><i class="fa-solid fa-gear me-3"></i>Settings</a></li>
            <li><a  onclick="logOut()" style="cursor:pointer; text-decoration: none; color: #8D98AF"><i class="fa-solid fa-arrow-right-from-bracket me-3"></i>Logout</a></li>
          </ul>
        </div>
      </div>


      <div class="container-fluid ">
        <div class="row">
           <!-- Sidebar -->
         <div class="col-md-2 sidebar d-md-block d-none">
          <ul class="listItem">
            <li>
              <a href="dashboard.html" class="nav-link">
                <i class="fa-solid fa-house me-lg-3 me-md-1"></i>
                <span>Dashboard</span>
              </a>
            </li>
            <li>
              <a href="orders.html" class="nav-link">
                <i class="fa-solid fa-cart-shopping me-lg-3 me-md-1"></i>
                <span>Orders</span>
              </a>
            </li>
            <li>
              <a href="product.html" class="nav-link">
                <i class="fa-solid fa-cart-shopping me-lg-3 me-md-1"></i>
                <span>Products</span>
              </a>
            </li>
            <li>
              <a href="categories.html" class="nav-link">
                <i class="fa-solid fa-layer-group me-lg-3 me-md-1"></i>
                <span>Category</span>
              </a>
            </li>
            <li>
              <a href="./customers.html" class="nav-link">
                <i class="fa-solid fa-user me-lg-3 me-md-1"></i>
                <span>Customer</span>
              </a>
            </li>
            <li>
              <a href="distributor.html" class="nav-link">
                <i class="fa-solid fa-truck-fast me-lg-3 me-md-1"></i>
                <span>Distributors</span>
              </a>
            </li>
            <li>
              <a href="" class="nav-link">
                <i class="fa-solid fa-file-invoice me-lg-3 me-md-1"></i>
                <span>Reports</span>
              </a>
            </li>
            <li>
              <a href="./notifications.html" class="nav-link">
                <i class="fa-solid fa-bell me-lg-3 me-md-1"></i>
                <span>Notifications</span>
              </a>
            </li>
            <li>
              <a href="" class="nav-link">
                <i class="fa-solid fa-receipt fa-beat me-lg-3 me-md-1"></i>
                <span>Coupons</span>
              </a>
            </li>
            <hr>
            <li>
              <a href="#" class="nav-link">
                <i class="fa-solid fa-envelope me-lg-3 me-md-1"></i>
                <span>Inbox</span>
              </a>
            </li>
            <li>
              <a href="#" class="nav-link">
                <i class="fa-solid fa-gear me-lg-3 me-md-1"></i>
                <span>Settings</span>
              </a>
            </li>
            <!-- <li class="mt-5">
              <a href="#" class="nav-link  Dashbutton" onclick="logOut(event)">
                <i class="fa-solid fa-arrow-right-from-bracket me-lg-3 me-md-1"></i>
                <span>Logout</span>
              </a>
            </li> -->
            <button class="Dashbutton mt-5 " style="cursor: pointer; " onclick="logOut()">
            <a  style="text-decoration: none; color:#8D98AF ;  "><i class="fa-solid fa-arrow-right-from-bracket me-3"></i></span><span class="logspan">Logout</span></a>
            </button>
          </ul>
        </div>

          <!-- Main Content -->
          <div class="col-md-10 p-4">
            <div class="d-flex align-items-center justify-content-between gap-3">
                  <h3>Catergory</h3>

                  <div class="div">
                      <!-- Button trigger ADD CATEGORY modal -->
                      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exampleModal">
                      + Add Category
                      </button>

                      <!-- ADD CATEGORY Modal -->
                      <div class="modal fade " id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                      <div class="modal-dialog">
                          <div class="modal-content">
                          <div class="modal-header">
                              <h1 class="modal-title fs-5" id="exampleModalLabel">Add Category</h1>
                          </div>
                          <div class="modal-body">
                              <div class="mb-3">
                                  <label for="exampleFormControlInput1" class="form-label">Category Name</label>
                                  <input type="email" class="form-control" id="cat" placeholder="">
                              </div>
                              <div class="mb-3">
                                  <label for="exampleFormControlInput1" class="form-label">image</label>
                                  <input type="email" class="form-control" id="catImg" placeholder="">
                              </div>

                              
                          </div>
                          <div class="modal-footer">
                              <button type="button" class=" btn-success" style="border: none; color: #00A859; background: transparent;"  data-bs-dismiss="modal">Cancel</button>
                              <button type="button" class="btn btn-success" onclick="createCategory(event)">
                                  <div class="spinner-border spinner-border-sm spin2" role="status">
                                  <span class="visually-hidden">Loading...</span>
                                  </div>
                                  Create category
                              </button>
                          </div>
                          </div>
                      </div>
                      </div>

                      <!-- Manage Categories Button -->
                      
                      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#updateCategoryModal">
                          Update Category
                      </button>
                      
                      <!-- Update Category Modal -->
                      <div class="modal fade" id="updateCategoryModal" tabindex="-1">
                      <div class="modal-dialog">
                          <div class="modal-content">
                          <form id="updateCategoryForm">
                              <div class="modal-header">
                              <h5 class="modal-title">Update Category</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                              </div>
                              <div class="modal-body">
                              <div class="mb-3">
                                  <label>Select Category</label>
                                  <select id="updateCategorySelect" class="form-select"></select>
                              </div>
                              <div class="mb-3">
                                  <label>Category Name</label>
                                  <input type="text" id="updateCategoryName" class="form-control" required>
                              </div>
                              <div class="mb-3">
                                  <label>Category Image URL</label>
                                  <input type="text" id="updateCategoryImage" class="form-control" required>
                              </div>
                              </div>
                              <div class="modal-footer">
                              <button type="submit" class="btn btn-success">Update</button>
                              <button type="button" id="deleteCategoryBtn" class="btn btn-danger">Delete</button>
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                              </div>
                          </form>
                          </div>
                      </div>
                      </div>

                      <!-- Delete Confirmation Modal -->
                      <div class="modal fade" id="deleteCategoryModal" tabindex="-1">
                      <div class="modal-dialog">
                          <div class="modal-content">
                          <div class="modal-header bg-danger text-white">
                              <h5 class="modal-title">Delete Category</h5>
                              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                              <p id="deleteCategoryMessage"></p>
                              <input type="hidden" id="deleteCategoryId">
                          </div>
                          <div class="modal-footer">
                              <button type="button" id="confirmDeleteCategory" class="btn btn-danger">Delete</button>
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          </div>
                          </div>
                      </div>
                      </div>
                  </div>
            </div>

              <!-- <div class="d-flex align-items-center justify-content-between mt-3">
                  <div class=" d-flex align-items-center ">
                      <select class="form-select selectINPUT" aria-label="Default select example">
                          <option selected>Filter</option>
                          <option value="1">One</option>
                          <option value="2">Two</option>
                          <option value="3">Three</option>
                      </select>   
                      
                      <div class="search-container ms-3">
                          <i class="fa fa-search search-icon"></i>
                          <input type="text" id="searchInput" placeholder="Search..." />
                      </div>
                  </div> 
                  <div class="div">
                      <button class="orderBtNN"><i class="fa-solid fa-pen-to-square"></i></button>
                      <button class="orderBtNN ms-2"><i class="fa-solid fa-trash"></i></button>
                  </div>      
              </div> -->
              <div class="row mt-5" id="categoriesContainer">
                  <!-- <div class="col-sm-12 col-md-6 col-lg-4">
                      <img src="./images/image (8).png" class="w-100" alt="">
                      <div class="ms-3">
                          <p>Organic Almond Delight</p>
                          <p>24 items</p>
                      </div>
                  </div>
                  <div class="col-sm-12 col-md-6 col-lg-4">
                      <img src="./images/Bitmap (1).png" class="w-100" alt="">
                      <div class="ms-3">
                          <p>Organic Almond Delight</p>
                          <p>24 items</p>
                      </div>
                  </div>
                  <div class="col-sm-12 col-md-6 col-lg-4">
                      <img src="./images/image (9).png" class="w-100" alt="">
                      <div class="ms-3">
                          <p>Organic Almond Delight</p>
                          <p>24 items</p>
                      </div>
                  </div> -->
              </div>

          </div>
        </div>
      </div>

      <script>
      async function loadCategories() {
        try {
          const categoriesRes = await fetch("http://localhost:3001/amazon/document/api/categories");
          const categories = await categoriesRes.json();
          const productsRes = await fetch("http://localhost:3001/amazon/document/api/products");
          const products = await productsRes.json();
          // Count products per category
          const productCountMap = {};
          products.forEach(p => {
            let catId = null;
            // case 1: categoryId field
            if (p.categoryId) catId = String(p.categoryId);
            // case 2: populated category object
            if (p.category && p.category._id) catId = String(p.category._id);
            if (catId) {
              productCountMap[catId] = (productCountMap[catId] || 0) + 1;
            }
          });
          // Render categories
          const container = document.getElementById("categoriesContainer");
          container.innerHTML = "";
          categories.forEach(cat => {
            const count = productCountMap[String(cat._id)] || 0;
            const card = `
              <div class="col-md-6 col-lg-4 mb-4">
                <div class="image-wrap ">
                  <img src="${cat.image}" class="card-img-top" style = "object-fit: cover; width: 100%; height: 250px;" alt="${cat.name}">
                </div>
                <div class="card-body mt-3">
                    <h5 class="card-title fw-bold">${cat.name}</h5>
                    <p class="text-muted mt-3">${count} Product${count !== 1 ? "s" : ""}</p>
                  </div>
              </div>
            `;
            container.insertAdjacentHTML("beforeend", card);
          });
        } catch (err) {
          console.error("Error loading categories:", err);
        }
      }
      document.addEventListener("DOMContentLoaded", loadCategories);
      </script>


      <script>
      document.addEventListener("DOMContentLoaded", () => {
        const categorySelect = document.getElementById("updateCategorySelect");
        const nameInput = document.getElementById("updateCategoryName");
        const imageInput = document.getElementById("updateCategoryImage");
        const deleteCategoryBtn = document.getElementById("deleteCategoryBtn");
        const deleteCategoryModal = new bootstrap.Modal(document.getElementById("deleteCategoryModal"));
        let categories = [];

        // Reuse loadCategories()
        async function loadCategoriesDropdown() {
          await loadCategories(); // your existing function
          const token = localStorage.getItem("key");
          try {
            const res = await fetch("http://localhost:3001/amazon/document/api/categories", {
              headers: { Authorization: `Bearer ${token}` }
            });
            categories = await res.json();
            categorySelect.innerHTML = categories.map(c => `<option value="${c._id}">${c.name}</option>`).join("");
            if (categories.length) {
              const first = categories[0];
              nameInput.value = first.name;
              imageInput.value = first.image || "";
            }
          } catch (err) {
            console.error(err);
            Swal.fire({ icon: "error", text: "Failed to load categories" });
          }
        }

        // Change handler for dropdown
        categorySelect.addEventListener("change", () => {
          const selected = categories.find(c => c._id === categorySelect.value);
          if (selected) {
            nameInput.value = selected.name;
            imageInput.value = selected.image || "";
          }
        });

        // Update category
        document.getElementById("updateCategoryForm").addEventListener("submit", async e => {
          e.preventDefault();
          const id = categorySelect.value;
          const token = localStorage.getItem("key");
          try {
            const res = await fetch(`http://localhost:3001/amazon/document/api/categories/${id}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`
              },
              body: JSON.stringify({
                name: nameInput.value,
                image: imageInput.value
              })
            });
            const result = await res.json();
            if (res.ok) {
            if (res.ok) {
        Swal.fire({ 
          icon: "success", 
          text: "Category updated!",
          timer: 1500,
          showConfirmButton: false 
        });

        // Option A: Live refresh without reloading page
        // await loadCategoriesDropdown();
        // if (typeof fetchProducts === "function") fetchProducts();
        // bootstrap.Modal.getInstance(document.getElementById("updateCategoryModal")).hide();

        // Option B: Full page reload
        setTimeout(() => {
          location.reload();
        }, 1500);
      }

              
            } else {
              Swal.fire({ icon: "error", text: result.message || "Update failed" });
            }
          } catch (err) {
            console.error(err);
            Swal.fire({ icon: "error", text: "Server error" });
          }
        });

        // Open delete confirmation modal
        deleteCategoryBtn.addEventListener("click", () => {
          const selected = categories.find(c => c._id === categorySelect.value);
          if (!selected) return;
          document.getElementById("deleteCategoryId").value = selected._id;
          document.getElementById("deleteCategoryMessage").innerText = `Are you sure you want to delete "${selected.name}"?`;
          deleteCategoryModal.show();
        });

        // Confirm delete
        document.getElementById("confirmDeleteCategory").addEventListener("click", async () => {
          const id = document.getElementById("deleteCategoryId").value;
          const token = localStorage.getItem("key");
          try {
            const res = await fetch(`http://localhost:3001/amazon/document/api/categories/${id}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` }
            });
            const result = await res.json();
            if (res.ok) {
              Swal.fire({ icon: "success", text: "Category deleted!" });
              deleteCategoryModal.hide();
              await loadCategoriesDropdown();
            } else {
              Swal.fire({ icon: "error", text: result.message || "Delete failed" });
            }
          } catch (err) {
            console.error(err);
            Swal.fire({ icon: "error", text: "Server error" });
          }
        });

        // Load on open
        document.getElementById("updateCategoryModal").addEventListener("show.bs.modal", loadCategoriesDropdown);
      });
      </script>
















<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/js/all.min.js" integrity="sha512-b+nQTCdtTBIRIbraqNEwsjB6UvL3UEMkXnhzd8awtCYh0Kcsjl9uEgwVFVbhoj3uu1DO1ZMacNvLoyJJiNfcvg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="./js/index.js"></script>
</body>
</html>
